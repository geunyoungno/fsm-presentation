# 04. ê³ ê¸‰ ì£¼ì œ

ì´ ì„¹ì…˜ì—ì„œëŠ” FSMì˜ ê³ ê¸‰ íŒ¨í„´ê³¼ ì‹¤ë¬´ ì ìš© ê¸°ë²•ì„ ë‹¤ë£¹ë‹ˆë‹¤.

## ğŸ“š ì£¼ìš” ì£¼ì œ

### 1. ê³„ì¸µì  ìƒíƒœ (Hierarchical States / Statecharts)

**Statechartsë€?**

David Harelì´ 1987ë…„ì— ì œì•ˆí•œ ê°œë…ìœ¼ë¡œ, ê¸°ë³¸ FSMì„ í™•ì¥í•˜ì—¬ ë³µì¡í•œ ì‹œìŠ¤í…œì„ ë” íš¨ê³¼ì ìœ¼ë¡œ ëª¨ë¸ë§í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.

**ì£¼ìš” ê°œë…:**

- **ì¤‘ì²© ìƒíƒœ (Nested States)**: ìƒíƒœ ì•ˆì— í•˜ìœ„ ìƒíƒœë¥¼ í¬í•¨
- **ë³‘ë ¬ ìƒíƒœ (Parallel States)**: ì—¬ëŸ¬ ìƒíƒœê°€ ë™ì‹œì— í™œì„±í™”
- **íˆìŠ¤í† ë¦¬ ìƒíƒœ (History States)**: ì´ì „ í•˜ìœ„ ìƒíƒœë¥¼ ê¸°ì–µ

**ì˜ˆì œ: ìŒì•… í”Œë ˆì´ì–´**

```
powerOff
powerOn
  â”œâ”€â”€ stopped
  â”œâ”€â”€ playing
  â”‚   â”œâ”€â”€ normal
  â”‚   â”œâ”€â”€ repeat
  â”‚   â””â”€â”€ shuffle
  â””â”€â”€ paused
```

**ì¥ì :**

1. **ë³µì¡ë„ ê´€ë¦¬**: í° ì‹œìŠ¤í…œì„ ì‘ì€ ë‹¨ìœ„ë¡œ ë¶„í•´
2. **ì½”ë“œ ì¬ì‚¬ìš©**: ê³µí†µ ì „ì´ë¥¼ ìƒìœ„ ìƒíƒœì— ì •ì˜
3. **ìœ ì§€ë³´ìˆ˜ì„±**: ê´€ë ¨ ìƒíƒœë¥¼ ê·¸ë£¹í™”í•˜ì—¬ ì´í•´í•˜ê¸° ì‰¬ì›€
4. **í™•ì¥ì„±**: ìƒˆë¡œìš´ í•˜ìœ„ ìƒíƒœ ì¶”ê°€ê°€ ìš©ì´

**ì‹¤ë¬´ í™œìš©:**
- ë³µì¡í•œ UI ì»´í¬ë„ŒíŠ¸ (ë¹„ë””ì˜¤ í”Œë ˆì´ì–´, ì—ë””í„° ë“±)
- ë‹¤ë‹¨ê³„ ìœ„ì €ë“œ/í¼
- ê²Œì„ ìƒíƒœ ê´€ë¦¬

---

### 2. ìƒíƒœ ì˜ì†í™” (State Persistence)

**ì™œ í•„ìš”í•œê°€?**

- ì‚¬ìš©ì ê²½í—˜ í–¥ìƒ: ì•± ì¬ì‹œì‘ í›„ì—ë„ ì´ì „ ìƒíƒœ ìœ ì§€
- ì˜¤ë¥˜ ë³µêµ¬: í¬ë˜ì‹œ í›„ ìƒíƒœ ë³µì›
- ë©€í‹° ë””ë°”ì´ìŠ¤: ì—¬ëŸ¬ ê¸°ê¸° ê°„ ìƒíƒœ ë™ê¸°í™”

**ì˜ˆì œ: ê²Œì„ ì €ì¥/ë¡œë“œ**

ê²Œì„ì˜ í˜„ì¬ ìƒíƒœ(ë ˆë²¨, ì ìˆ˜, ìƒëª…)ë¥¼ íŒŒì¼ì— ì €ì¥í•˜ê³ , ë‚˜ì¤‘ì— ë¶ˆëŸ¬ì™€ì„œ ê²Œì„ì„ ì´ì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ì €ì¥ ë°©ì‹:**

| ë°©ì‹ | ì‚¬ìš© ì‚¬ë¡€ | ì¥ì  | ë‹¨ì  |
|------|----------|------|------|
| **íŒŒì¼ ì‹œìŠ¤í…œ** | ë°ìŠ¤í¬í†± ì•± | ê°„ë‹¨, ì˜¤í”„ë¼ì¸ ê°€ëŠ¥ | ë™ê¸°í™” ì–´ë ¤ì›€ |
| **LocalStorage** | ì›¹ ì•± | ë¹ ë¦„, ê°„ë‹¨ | ìš©ëŸ‰ ì œí•œ (5-10MB) |
| **IndexedDB** | ì›¹ ì•± (ëŒ€ìš©ëŸ‰) | ëŒ€ìš©ëŸ‰ ê°€ëŠ¥ | ë³µì¡í•œ API |
| **Database** | ë©€í‹° ìœ ì € | ì¤‘ì•™ ê´€ë¦¬, ì¿¼ë¦¬ ê°€ëŠ¥ | ë„¤íŠ¸ì›Œí¬ í•„ìš” |
| **Cloud Storage** | ë©€í‹° ë””ë°”ì´ìŠ¤ | ë™ê¸°í™” ì‰¬ì›€ | ë¹„ìš©, ì§€ì—° |

**êµ¬í˜„ íŒ¨í„´:**

```typescript
// 1. ìƒíƒœ ì§ë ¬í™”
const stateSnapshot = actor.getSnapshot();
const serialized = JSON.stringify(stateSnapshot.context);

// 2. ì €ì¥
localStorage.setItem('appState', serialized);

// 3. ë³µì›
const saved = localStorage.getItem('appState');
const context = JSON.parse(saved);
actor.send({ type: 'RESTORE', context });
```

**ì£¼ì˜ì‚¬í•­:**

- ğŸ”’ **ë³´ì•ˆ**: ë¯¼ê°í•œ ì •ë³´ëŠ” ì•”í˜¸í™”
- ğŸ”„ **ë²„ì „ ê´€ë¦¬**: ìŠ¤í‚¤ë§ˆ ë³€ê²½ ì‹œ ë§ˆì´ê·¸ë ˆì´ì…˜
- âš ï¸ **ì—ëŸ¬ ì²˜ë¦¬**: ì €ì¥/ë¡œë“œ ì‹¤íŒ¨ ì²˜ë¦¬
- ğŸ§¹ **ì •ë¦¬**: ì˜¤ë˜ëœ ë°ì´í„° ì‚­ì œ ì •ì±…

---

## ì˜ˆì œ íŒŒì¼

- `src/hierarchical-states.ts`: ê³„ì¸µì  ìƒíƒœ ì˜ˆì œ
- `src/state-persistence.ts`: ìƒíƒœ ì˜ì†í™” ì˜ˆì œ

## ğŸ¯ ì‹¤ë¬´ ì ìš© ì‹œ ê³ ë ¤ì‚¬í•­

### 1. ì–¸ì œ FSMì„ ì‚¬ìš©í•´ì•¼ í•˜ë‚˜?

**ì í•©í•œ ê²½ìš°:**
- âœ… ëª…í™•í•œ ìƒíƒœê°€ ì¡´ì¬
- âœ… ìƒíƒœ ê°„ ì „ì´ ê·œì¹™ì´ ë³µì¡
- âœ… ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ì¤‘ìš”
- âœ… ë””ë²„ê¹…/ì¶”ì ì´ í•„ìš”

**ë¶€ì í•©í•œ ê²½ìš°:**
- âŒ ë‹¨ìˆœí•œ boolean í”Œë˜ê·¸ë¡œ ì¶©ë¶„
- âŒ ìƒíƒœê°€ ë§¤ìš° ë™ì  (ë¬´í•œëŒ€)
- âŒ ì„±ëŠ¥ì´ ê·¹ë„ë¡œ ì¤‘ìš” (ì˜¤ë²„í—¤ë“œ)

### 2. ë””ë²„ê¹… ì „ëµ

**XState DevTools:**
```typescript
import { inspect } from '@statelyai/inspect';

const actor = createActor(machine, {
  inspect: inspect({
    iframe: false // ë¸Œë¼ìš°ì € DevTools ì‚¬ìš©
  })
});
```

**ë¡œê¹…:**
```typescript
machine.on('*', (event, state) => {
  console.log(`[${state.value}] ${event.type}`);
});
```

### 3. í…ŒìŠ¤íŠ¸ ì „ëµ

**ìƒíƒœë³„ í…ŒìŠ¤íŠ¸:**
```typescript
test('should transition to success on SUBMIT', () => {
  const state = machine.transition('editing', { type: 'SUBMIT' });
  expect(state.value).toBe('success');
});
```

**ê²½ë¡œ í…ŒìŠ¤íŠ¸:**
```typescript
test('full workflow', () => {
  let state = machine.initialState;
  state = machine.transition(state, { type: 'START' });
  state = machine.transition(state, { type: 'PROCESS' });
  state = machine.transition(state, { type: 'COMPLETE' });
  expect(state.value).toBe('done');
});
```

### 4. ì„±ëŠ¥ ìµœì í™”

- **ë©”ëª¨ì´ì œì´ì…˜**: ë™ì¼í•œ ìƒíƒœ ì „ì´ ê²°ê³¼ ìºì‹±
- **Lazy Loading**: í•„ìš”í•œ ìƒíƒœë§Œ ë™ì  ë¡œë“œ
- **ìƒíƒœ ë¶„í• **: í° ë¨¸ì‹ ì„ ì—¬ëŸ¬ ì‘ì€ ë¨¸ì‹ ìœ¼ë¡œ ë¶„ë¦¬

---

## ğŸ“– ì¶”ê°€ í•™ìŠµ ë¦¬ì†ŒìŠ¤

### ê³µì‹ ë¬¸ì„œ
- [XState ê³µì‹ ë¬¸ì„œ](https://xstate.js.org/docs/)
- [Stately Studio](https://stately.ai/studio) - ì‹œê°í™” ë„êµ¬
- [State Machine Catalog](https://stately.ai/registry) - ì˜ˆì œ ëª¨ìŒ

### í•™ìŠµ ìë£Œ
- [Statecharts ì›ë³¸ ë…¼ë¬¸](https://www.sciencedirect.com/science/article/pii/0167642387900359) - David Harel (1987)
- [The World of Statecharts](https://statecharts.dev/) - Statecharts ì¢…í•© ê°€ì´ë“œ
- [XState Visualizer](https://stately.ai/viz) - ì˜¨ë¼ì¸ ì‹œê°í™” ë„êµ¬

### ì»¤ë®¤ë‹ˆí‹°
- [XState Discord](https://discord.gg/xstate)
- [GitHub Discussions](https://github.com/statelyai/xstate/discussions)

---

## ì‹¤í–‰ ë°©ë²•

ì•„ë˜ ëª…ë ¹ì€ **ë ˆí¬ ë£¨íŠ¸**ì—ì„œ ì‹¤í–‰í•œë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.

```bash
# ì˜ì¡´ì„± ì„¤ì¹˜
pnpm install

# TypeScript ì»´íŒŒì¼
pnpm -C 04-advanced-topics run build

# ê³„ì¸µì  ìƒíƒœ ì˜ˆì œ ì‹¤í–‰
pnpm -C 04-advanced-topics run hierarchical

# ìƒíƒœ ì˜ì†í™” ì˜ˆì œ ì‹¤í–‰
pnpm -C 04-advanced-topics run persistence
```

## ìƒíƒœ ì €ì¥ íŒŒì¼ ìœ„ì¹˜

`state-persistence` ì˜ˆì œëŠ” ì‹¤í–‰ í´ë” ê¸°ì¤€ìœ¼ë¡œ `game-save.json`ì„ ìƒì„±í•˜ë©°, ë°ëª¨ ì‹œì‘/ì¢…ë£Œ ì‹œ ìë™ìœ¼ë¡œ ì‚­ì œí•©ë‹ˆë‹¤.

---

## ğŸ“ í•µì‹¬ ìš”ì•½

1. **ê³„ì¸µì  ìƒíƒœ**: ë³µì¡í•œ ì‹œìŠ¤í…œì„ êµ¬ì¡°í™”í•˜ëŠ” ê°•ë ¥í•œ ë„êµ¬
2. **ìƒíƒœ ì˜ì†í™”**: ì‚¬ìš©ì ê²½í—˜ì„ í–¥ìƒì‹œí‚¤ëŠ” í•„ìˆ˜ ê¸°ëŠ¥
3. **ì‹¤ë¬´ ì ìš©**: ì˜¬ë°”ë¥¸ ë„êµ¬ë¥¼ ì˜¬ë°”ë¥¸ ë¬¸ì œì— ì‚¬ìš©í•˜ë¼
4. **í…ŒìŠ¤íŠ¸**: FSMì€ í…ŒìŠ¤íŠ¸í•˜ê¸° ì‰¬ìš´ êµ¬ì¡°ë¥¼ ì œê³µ
5. **ë¬¸ì„œí™”**: ìƒíƒœ ë‹¤ì´ì–´ê·¸ë¨ì€ ìµœê³ ì˜ ë¬¸ì„œ

---

## ë‹¤ìŒ ë‹¨ê³„

ë©”ì¸ ë¬¸ì„œ([fsm.md](../fsm.md))ë¡œ ëŒì•„ê°€ì„œ ì „ì²´ ë‚´ìš©ì„ ë³µìŠµí•˜ê±°ë‚˜, ê° ì„¹ì…˜ì˜ ì½”ë“œë¥¼ ì§ì ‘ ìˆ˜ì •í•˜ë©° ì‹¤í—˜í•´ë³´ì„¸ìš”!
